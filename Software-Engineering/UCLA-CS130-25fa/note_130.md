# LEC1 Intro

exam will be multiple choice question generated by Gemini, each exam only covers half of the content, 1 hour

```
git clone ssh://yuhengtu@code.cs130.org:29418/semiconductor-savants
---
tools/env/start.sh -u yuhengtu -r -- -p 127.0.0.1:8080:8080
git checkout -b xxx
...
cd build
cmake ..
make
make test
...
cd build_coverage
cmake -DCMAKE_BUILD_TYPE=Coverage ..
make coverage
...

...
git status
git add .
git commit -m "
git review -f
---
git review -l
git review -d my_change_id
git add .
git commit --amend --no-edit
git review -f
code review +1 and submit on Gerrit web UI
---
git checkout main
git pull --rebase
git checkout my-new-feature
git rebase main
```

git rebase main, rebase is better than merge. It takes all the commits on your feature branch and replays them, one by one, on top of the latest version of main. This creates a clean, linear history



# Modern Cpp

| Passing Style           | Definition Syntax      | Call Syntax | What gets passed?        | Can modify original?  | Typical usage                        |
| ----------------------- | ---------------------- | ----------- | ------------------------ | --------------------- | ------------------------------------ |
| Pass by value           | `void f(int x)`        | `f(a);`     | A **copy** of `a`        | ❌ No                  | Small, simple types                  |
| Pass by reference       | `void f(int& x)`       | `f(a);`     | Original `a`             | ✅ Yes                 | Modify caller safely                 |
| Pass by const reference | `void f(const int& x)` | `f(a);`     | Original `a`, read-only  | ❌ No                  | Large objects you don’t want to copy |
| Pass by pointer         | `void f(int* x)`       | `f(&a);`    | Pointer to  original `a` | ✅ Yes, can be nullptr | Optional (nullptr) or dynamic memory |

DO NOT use raw pointers (new & delete), use Smart Pointer and RAII

![image-20251029164155208](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510300741242.png)



# learngitbranching

in learngitbranching, c0/c1 is a commit hash

branch/HEAD are pointer to commits

HEAD or * is current checkout (useless: HEAD -> main (branch) -> a1b2c3 (commit), detach HEAD, HEAD -> a1b2c3)

bugFix^^ = bugFix~2 (Useless: git branch -f main HEAD~3)

git reset HEAD~1 (for local branch, not for remote branch that others use as well)

![image-20251007233704355](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510081437465.png)

git revert HEAD (share reversed changes with others)

![image-20251007233826836](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510081438894.png)

git rebase -i HEAD~3 #修改顺序

git branch -f master bugFix

![image-20251008002933616](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510081529651.png)



useless:

git cherry-pick c3 c4 c7

![image-20251008002332496](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510081523533.png)

git rebase -i HEAD~4 #修改顺序

![image-20251008002414894](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510081524931.png)

need to slightly modify an early commit c2

1. git rebase -i HEAD~2 #修改C2和C3的顺序
2. git commit --amend
3. git rebase -i HEAD~2 #修改C3'和C2''顺序
4. git branch -f master

![image-20251008003515938](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510081535982.png)

1. git checkout master
2. git cherry-pick newImage
3. git commit *--amend*
4. git cherry-pick caption

![image-20251008004654160](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510081546256.png)

git tag v0 c1: branch is fragile, tag is permanent, you can't check out a tag and commit on the tag

git describe <ref>, <tag>-<numCommits>-g<hash>: describe where you are relative to the closest tag

git checkout main, goes to c1; git checkout main^2, goes to c2

![image-20251012225601943](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510131356056.png)

git branch bugWork HEAD\~\^2~

![image-20251012225815624](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510131358666.png)



# LEC2 Test

Unit Test/Integration Test/End-to-End Test

testable code:

- Testing boundaries: do not test main loop

- Refactoring for testability: e.g., extract a handler
- make the fn return sth instead of void
- Dependency Injection (e.g., can pass in the test db or real db to the class construction), Inversion of Control (IoC)
  - composition (has-a) > inheritance (is-a)
  - new is harmful, get dependency from outside (new clock in the main fn)

test object:

- real object
- fake object (simulate real)
- mock object (input -> output)

fake > mock

test what is the output (1,2,3) instead of how is the output (internal behavior)

Test readability:

- DRY: Don't Repeat Yourself
- DAMP: Descriptive and Meaningful Phrases



Unit tests is for single componenet

Integration test tests the componenet connection

- Slow -> focus on happy path tests
- hard to write / debug

Test script of the webserver running binary:

- Start the server process

- Send it an HTTP request
- Capture the server's response
- Verify the response is correct
- Shut down the server process

![image-20251015191619168](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510161016210.png)

Make your integration test part of main build (can be run with `make test`)

```
add_test(NAME web_server_integration_test
         COMMAND ${CMAKE_CURRENT_SOURCE_DIR}/tests/my_test.sh
         WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/tests)
```



# HW1 Nginx Config

- directives: 

  - Simple directives: worker_processes 1;

  - Block directives: 

    http {
        include       mime.types;
        default_type  application/octet-stream;
    }

- context: block directives that can contain other directives

  http {
      server {
          listen 80;
      }
  }

- main context: directive placed outside of any block



# LEC3 HTTP & Commit message

HTTP request (client to server)

- There is \r\n (CRLF 回车换行) at the end of each line

- The request ends with a blank line (\r\n\r\n)

- e.g.:

  GET /index.html HTTP/1.1

  Host: www.example.com

  User-Agent: curl/7.68.0

  Accept: * / *

  *<blank line>*

1. The Request Line

   GET /path/to/file.html HTTP/1.1

   GETorPOST /path/to/file.html(URI) HTTP/1.1(HTTP protocol version)

2. Zero or more Request Header Lines

   Host: www.example.com (Required in HTTP/1.1)

   User-Agent: Mozilla/5.0 (X11; Linux x86_64) ...

3. A single Blank Line (\r\n)

4. An optional Message Body (Not used for GET requests)

   - POST (create a new entry)
   - PUT (update an existing entry)



HTTP response (server to client)

- The body of the e.g. response is the complete request from our earlier example

- e.g.:

  HTTP/1.1 200 OK

  Content-Type: text/plain

  Content-Length: 88

  *<blank line>*

  GET /index.html HTTP/1.1

  Host: www.example.com

  User-Agent: curl/7.68.0

  Accept: * / *

1. The Status Line

   HTTP/1.1 200 OK

   Status Code (200 OK, 404 Not Found, 400 Bad Request, 500 Internal Server Error) + Reason Phrase (A short, human-readable text description of the status code)

2. Zero or more Response Header Lines

   - Content-Type: text/plain

     MIME type of message body, e.g., text/html, image/jpeg, application/json

   - Content-Length: 123

     Size of message body in bytes

3. A single Blank Line (\r\n)

4. An optional Message Body



curl -v http://localhost:8080/echo

- -v (verbose) flag is essential

- It shows you the raw HTTP request curl sends
- It also shows you the raw HTTP response your server sends back

browser developer tools

- F12
- Ctrl+Shift+I
- Cmd+Opt+I on Mac



The #1 rule: make your changes small

- Refactoring First and Only
- Backend first then frontend
- Submit new class definition and header file first for design feedback, add method implementations in subsequent changes.

change description

```
#What Updates authentication to support passwordless @google.com login.

#Why According to #ticket-3 >70% of our users have a google.com email and surveys from PR #ticket-8 show requests for smoother password-less logon using accounts such as Facebook or Google.

#How When a user attempts to sign in they'll have an option to use an email/password or click a google-login button that steps through the oauth flow in <design doc link>, using redirect /oauth_login/google/user?access_token.
Screenshots of the login screen in design doc <link>.

#Testing
 - Added a test account test-user-login@google.com
 - Added selenium tests that exercise the login
```



# LEC4 Cmake & Docker

CMake: automated, efficient, portable building of C++ projects (dependencies & compiler commands)

- Reads configuration files named CMakeLists.txt
- Detects OS, compiler, and installed libraries
- Generates native build files

1. cmake .. 

   Run from a build directory to generate Makefiles

2. make

   Use the generated Makefiles to build your code

Continuous Integration: automatically build and test your code every time you submit a change.



Docker: package the app and its environment together

Image: Snapshot of OS defined by Dockerfile, created by `docker build`, starts from a base image (e.g. ubuntu), can be tagged with versions (e.g. web:stable)

Container: an instance of Image, created by `docker run`. When you stop a container, you lost everything.

Volume/Bound mount (directory on host VM): permanently store data from the container or share data among containers

Port: Expose container ports to: Host (use 127.0.0.1), Internet (use 0.0.0.0). Define in: Image (Dockerfile) for documentation, Container (docker run) for implementation

![image-20251009164215986](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510100742114.png)

Write a Dockerfile, each instruction creates a layer in the image, syntax: INSTRUCTION arguments

1. Define **base image**: 

   - FROM ubuntu:22.04

   - FROM postgres:14-alpine

   - FROM gcr.io/my-project/my-image:latest

2. **RUN** <command>: Install packages, compile code, create directories

   - RUN apt-get update &&

       apt-get install -y \

       build-essential \

       cmake \

       libboost-all-dev

3. **COPY** <src> <dest>: Copy files from local machine into the image

   - COPY . /usr/src/app (copy files in . to /usr/src/app)

   - COPY build/bin/server /usr/bin/

4. **WORKDIR** /path/to/work/dir: change directories, same as cd

5. **EXPOSE** <port>: Declare a port within the container should be exposed externally, just for documentation, requires -p with docker run to actually publish the port

6. **ENTRYPOINT** ["executable", "param1"]: Specifies the binary to run within the container

   **CMD** ["param2", "param3"]: Provides default arguments to ENTRYPOINT

   - ENTRYPOINT ["/usr/local/bin/webserver"]
     CMD ["--config", "/etc/server.conf"]

7. **Multi-stage builds**: build (compile), then deploy (run)

   2 FROM instruction, each begins a new build stage

   - **Stage 1:** **builder**

     - A large image with all our build tools (g++, cmake, etc.).

     - Used to compile our C++ code.

   - **Stage 2:** **deploy**

     - A minimal, clean base image (like ubuntu:latest).

     - copy only the compiled binary from the builder stage.

   Benefits: Small final image size

```dockerfile
# Stage 1: The Builder
FROM cs130/devel as builder

# Copy all source code into the image
WORKDIR /usr/src/project
COPY . .

# Create a build directory and compile the code
WORKDIR /usr/src/project/build
RUN cmake ..
RUN make

# Stage 2: The Final Deployment Image
FROM ubuntu:latest

# Copy the compiled binary from the 'builder' stage
COPY --from=builder /usr/src/project/build/bin/webserver /usr/local/bin/

# Copy the server configuration file
COPY config/server.conf /etc/server.conf

EXPOSE 80
ENTRYPOINT ["/usr/local/bin/webserver"]
CMD ["/etc/server.conf"]
```

docker build -t <image_name>:<tag> .

- . is the "build context"
- docker build -t my-webserver:v1 .

docker run -p <host_port>:<container_port> <image_name>:<tag>

- docker run -p 8080:80 my-webserver:v1
- map host port 8080 to container port 80

docker run -d ...

- run the container in detached mode (in the background)
- docker run -d -p 8080:80 --name my-server my-webserver:v1

docker ps

- Lists all currently running containers

docker stop <container_id_or_name>

- Stops a running container gracefully



# LEC5 Cloud Deployment & Continuous Integration & Release

1. Package your application into a self-contained Docker image

   gcr.io/<project-id>/<image-name>:<tag>

   gcr.io/cs130-223806/nginx:latest

   Use `docker tag` to apply full name to local image

2. Push that image to a container registry

   container registry: central, cloud-based storage for docker image (docker push, docker pull).

   E.g., Docker Hub, Google Artifact Registry

3. Build in the cloud (Google cloud build)

   cloudbuild.yaml

   ![image-20251015183943382](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510160939529.png)

   `gcloud builds submit --config docker/cloudbuild.yaml .`

   “.” specifies build context

4. Run the image from a cloud server (VM) that pulls from the registry (Google compute engine)

   Firewall Rule, Check the "Allow HTTP traffic" box, This opens port 80 to the public internet

   `gcloud compute ssh your-vm-instance-name`

   debug

   - docker ps, docker logs
   - curl to localhost at VM



Continuous Integration (CI)

- Frequently merging all developers' code into the main branch

- Each merge automatically triggers a build, Each build automatically runs a suite of tests

- Goal: Detect integration errors as quickly as possible.

Green/Red build

Set up CI (Cloud Build doesn’t integrate with private Gerrit):

- Create a read-only mirror of Gerrit repository inside Google Cloud
- Gerrit Repo → Submit → Cloud Source Repo → Trigger → Cloud Build

Creating a Cloud Build trigger

- Event: Push to a branch

- Source: Your mirror repository

- Branch: ^main$ (regular expression (regex) used to exact match the main branch)

- Configuration: The path to your cloudbuild.yaml file

Watch the cloud build Histroy. cloudbuild.yaml does build -> test -> push, any step fails, push does not happen



`:latest` tag points to the most recent version, automatically changes after each successful build.

-> DO NOT use `:latest` in production (VM run)

QA cycle stands for a Quality Assurance cycle

For Deliberate Release, `:release` usually means stable version, `:dev` or `:testing` means edge version

![image-20251015190434789](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510161004838.png)

Suggested release workflow:

- CI automatically builds and tests every commit, creating new `:latest`

- When the team decides to release, the TL pulls the current `:latest` image
  - `docker pull my-image:latest`

- The TL performs a final manual check (e.g., runs it locally)

- If it’s good, they re-tag the image and push:

  - `docker tag my-image:latest my-image:release`

  - `docker push my-image:release`

- Restart the production VM to pick up the new `:release` version



# LEC6 Webserver architecture & Logging

Webserver architecture

- Request handlers

- Request container & parser

- Response container & generator

- Dispatcher (router)
- ...



use logging libraries (Boost.log)

**log rotation** (to deal with large log files, logging libraries can handle automatically), e.g.,

- Cap usage at 100MB
- When current log file grows larger than 10MB:
  - Rename log file and timestamp it
  - Start a new log file
- If more than 10 log files, delete the oldest one

saves log in remote (cloud), not in container



# LEC7 Static Analysis & Code Style

static analysis: find bug in code without executing it (can be false positive/negative)

- memory errors:

  - use after free (access memory after delete)
  - buffer overrun (write past end of array)

- logic concurrency errors:

  - deadlock (Thread A locks Mutex 1 then waits for Mutex 2, Thread B locks Mutex 2 then waits for Mutex 1)

    Mutex (mutual exclusion): Thread A: lock the mutex → access the data → unlock, Thread B: wait until mutex unlock

  - dead code (condition impossible to be True)

-> add metadata to code as hint to static analyzer

![image-20251026122614402](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510270326536.png)

![image-20251026123343046](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510270333097.png)

static analyses:

- clang-tidy:

  - Powerful linter that finds common programming errors, style violations, and bugs

  - Configurable super-set of compiler warnings

- clang-format:

  - Automated code formatter

  - Reformats your code to match a consistent style guide

runtime analysis: runs program in a special, instrumented env that watches for bad behavior

- memcheck:
  - Watch for memory leaks, invalid reads/writes (buffer overflows), use of uninitialized variables
  - Very slow

coverage report:

- gcovr:
  - prove which line of the code is not tested



Code Style

![image-20251026124053714](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510270340764.png)

function should do one thing

comment should only help reader save time

![image-20251026124219087](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510270342129.png)

don't use tmp, data, a as variable name

![image-20251026124909904](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510270349929.png)

Google C++ Style:

- **k** prefix for constants
- **CamelCase** for class names
- **lower_snake_case** for variable names
- Trailing underscore for private member variables

![image-20251026125209668](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510270352698.png)

Typed units

![image-20251026124823262](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510270348306.png)

Break code into logic paragraphs

avoid nesting

![image-20251026125443626](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510270354679.png)

avoid control flow variable

![image-20251026125531098](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510270355146.png)

make variable less visable when possible

![image-20251026125631773](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510270356816.png)



# LEC8 Refactor & Design Pattern & Debug

Refactor -> pass test

parameter object

![image-20251026132827623](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510270428725.png)

factory method instead of constructor

call `auto server = HttpServer::Make(80);` instead of normal constructor `HttpServer server(80);`

![image-20251026141037874](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510270510980.png)

builder

![image-20251026141300678](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510270513735.png)



Design Patterns: general, reusable solutions to common problems in software engineering

1. Observer: e.g., when open a file, multiple things happen: update UI, record log, ...

   Instead of writing them one by one, we can throw them to observer

   ![image-20251026171151906](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510270811999.png)

2. Lazy initialization: for expensive initialization, create when requested

   ![image-20251026171516848](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510270815887.png)

3. Factories

   ![image-20251026172413474](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510270824515.png)

4. Singleton: a class only have one global instance

   ![image-20251026172659687](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510270826729.png)

5. Pools/freelist: resources that are expensive to create when requested (e.g., database connection), pre-allocate a pool of them; take from pool and return to pool for reuse

   ![image-20251026173013682](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510270830728.png)

6. RAII (Resource Acquisition Is Initialization): Tie the lifetime of the resource to the lifetime of an object on the stack

   - `std::unique_ptr` and `std::shared_ptr` for memory
   - `std::lock_guard` for mutexes
   - `std::ifstream` for files

   ![image-20251026173453951](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510270834014.png)

7. Decoraters: add features at run time without changing code behavior

   ![image-20251026173716008](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510270837059.png)

8. Continuation: avoid long running task to block main thread (async in Python)

   ![image-20251026174511738](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510270845812.png)

9. Strategy: dynamically execute streategy at run time

   ![image-20251026174957314](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510270849363.png)



Debug: reproduce -> hypothesis -> experiment -> fix bug and write a new test

GDB/LLDB:

- Set Breakpoints
  - break server.cc:123
  - break MyClass::MyMethod
  - Conditional: break server.cc:123 if user_id == "guest"

- Control Execution:
  - run: Start the program.
  - continue: Run until the next breakpoint.
  - next: Execute the next line (step over functions).
  - step: Execute the next line (step into functions).

- Inspect State:
  - print my_variable
  - backtrace: Show the current call stack.
- change variables on the fly

Binary test search: After 100 commits, sth fail -> use `git bisect`, an automated binary search through your commit history

- Takes a "good" commit (test passes) and a "bad" commit (test fails)
- Git checks out a commit in the middle
- You run the test
- Tell it if it's "good" or "bad"
- Git cuts the search space in half and repeats (binary search)



# LEC9 API Design

API Design: simple, hard to misuse; do one thing; generalize across repeated code, extensible; hide implementation details; do not take concrete classs (e.g., a real database); once released cannot delete, be careful to add argument

![image-20251029163337927](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510300733977.png)

![image-20251029164030324](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510300740422.png)

![image-20251029164050707](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510300740759.png)

![image-20251029164618800](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510300746869.png)

design example of CSVReader

1. Builder

![image-20251029165424075](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510300754142.png)

![image-20251029165433754](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510300754804.png)

2. read line by line to save memory

![image-20251029165552575](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510300755647.png)

![image-20251029165603950](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510300756009.png)

3. use line name instead of index to locate

![image-20251029165729361](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510300757425.png)

![](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510300757491.png)

4. error handling

Change the return type of Read() to a type that can hold either a successful result or an error status

- Common pattern in modern C++ and other languages
  - e.g. Go’s *(result, err)* or Rust’s *Result<T, E>*

Use StatusOr<T> object:

- Contains a status
  - e.g., *OK, NOT_FOUND, PARSE_ERROR*
- If status *OK*, it also contains the resulting value *(T)*

Client checks status before accessing value

![image-20251029165933719](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510300759782.png)

Finally,

![image-20251029170042451](https://cdn.jsdelivr.net/gh/yuhengtu/typora_images@master/img/202510300800516.png)
